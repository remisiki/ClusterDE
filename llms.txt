# ClusterDE

-----

The R package **ClusterDE** is a post-clustering DE method for
controlling the false discovery rate (FDR) of identified between
cell-type DE genes regardless of clustering quality. The core idea of
ClusterDE is to generate real-data-based synthetic null data with only
one cell type, as contrast to the real data, for evaluating the whole
procedure of clustering followed by a DE test.  **Detailed tutorials
that illustrate various functionalities of ClusterDE are available at
this
[website](https://songdongyuan1994.github.io/ClusterDE/index.html)**.
The following illustration figure summarizes the usage of ClusterDE:

![](reference/figures/ClusterDE_illustration.png)

Instead of a new pipeline, ClusterDE actually works as an add-on to
popular pipelines such as Seurat. To find out more details about
**ClusterDE**, you can check out our manuscript on
[bioRxiv](https://www.biorxiv.org/content/10.1101/2023.07.21.550107v1).

# Changelog

  - 2024-06-29 Important changes
      - Add functions for spatial clustering

**The motivation and application of ClusterDE**: In Seurat function
`findMarkers`, the authors pointed out: *“p-values should be interpreted
cautiously, as the genes used for clustering are the same genes tested
for differential expression.”* This is the “double-dipping” issue. If
your clustering results are inaccurate and since the clustering has used
your expression data already, the discovered DE genes may not represent
the discrete cell type separation, but other variation in your data
(e.g., cell cycle, total UMI, or other variation you are not clear.
These are still biological variation but do not define discrete status).

ClusterDE aims at correcting the double-dipping issue for comparing two
dubious clusters, which you are not sure if they are two discrete cell
types or just an artifact of your clustering algorithm based on
conventional DE analysis. ClusterDE controls the false discoveries in DE
and prioritizes the true cell type markers.

Note: current version is focusing on one vs one comparison.

# Installation

To install the development version from GitHub, please run:

``` r
if (!require("devtools", quietly = TRUE))
    install.packages("devtools")
devtools::install_github("SONGDONGYUAN1994/ClusterDE")
```

Please note that ClusterDE is actually a wrapper of **scDesign3**.
Therefore, you can also directly use scDesign3 to " design" your own
synthetic null data. To better understand scDesign3, you can check out
our manuscript on Nature Biotechnology:

[Song, D., Wang, Q., Yan, G. et al. scDesign3 generates realistic in
silico data for multimodal single-cell and spatial omics. *Nat
Biotechnol* (2023).](https://www.nature.com/articles/s41587-023-01772-1)

# Quick Start

A basic way to identify differentially expressed genes (DEGs) between
two clusters is to use `ClusterDE::findMarkers()` on a Seurat object
that already contains the count matrix and clustering results.

``` r
# obj is a preprocessed Seurat object with clustering completed
markers <- ClusterDE::findMarkers(obj, ident.1 = 0, ident.2 = 1)
```

This generates a list of genes ranked by contrast score (cs), where
higher scores indicate stronger differential expression.

``` r
head(markers)
# # A tibble: 6 × 3
#   gene        cs record
#   <chr>    <dbl>  <dbl>
# 1 CDKN1C    39.9      1
# 2 CD79B     38.6      1
# 3 FCGR3A    33.8      1
# 4 CKB       32.3      1
# 5 SIGLEC10  24.4      1
# 6 MTSS1     23.8      1
```

  - gene: gene symbol
  - cs: contrast score
  - record: indicator of reproducibility across null replicates

# Other Usages

## PCA approximation

For faster and more stable DEG detection when using multiple null-data
replicates, we recommend using the **PCA-based approximation** for
generating synthetic null data. Enable this by setting the `flavour`
argument in `findMarkers()` to `"pca"` (default is `"classic"`).
Increase the number of threads (`nCores`) to speed up parallel
calculation.

``` r
markers <- ClusterDE::findMarkers(obj, ident.1 = 0, ident.2 = 1, flavour = "pca", nCores = 8, nRep = 40)
```

## Customize null data generation

Beyond the default `findMarkers()` parameters, ClusterDE also allows
users to customize the analysis pipeline, particularly the generation
and inspection of synthetic null data.

The example below shows how to manually generate null data from a
gene-by-cell matrix containing the two clusters of interest. For typical
UMI count data, we recommend using the Negative Binomial model (`nb`).
The synthetic null data generation is relatively time-consuming; you may
use the fast version (`fastVersion = TRUE`).

``` r
data(exampleCounts)
nullData <- ClusterDE::constructNull(
  mat = exampleCounts,
  family = "nb",
  formula = NULL,
  extraInfo = NULL,
  nCores = 1,
  parallelization = "mcmapply",
  fastVersion = FALSE,
  corrCut = 0.2,
  BPPARAM = NULL
)
```

The parameters of `constructNull()` are:

  - `mat`: The input gene by cell matrix. It can be a sparse matrix.
  - `family`: A string of the distribution you want to use when fitting
    the model. Must be one of ‘poisson’, ‘nb’, ‘zip’, ‘zinb’ or
    ‘gaussian’.
  - `formula`: A string of the mu parameter formula. It defines the
    relationship between gene expression in synthetic null data and the
    extra covariates. Default is NULL (cell type case). For example, if
    your input data is a spatial data with X, Y coordinates, the formula
    can be ‘s(X, Y, bs = ’gp’, k = 4)’.
  - `extraInfo`: A data frame of the extra covariates used in . For
    example, the 2D spatial coordinates. Default is NULL.
  - `nCores`: An integer. The number of cores to use. Increasing the
    cores will greatly speed up the computation.
  - `parallelization`: A string indicating the specific parallelization
    function to use. Must be one of ‘mcmapply’, ‘bpmapply’, or
    ‘pbmcmapply’, which corresponds to the parallelization function in
    the package ‘parallel’, ‘BiocParallel’, and ‘pbmcapply’
    respectively. The default value is ‘pbmcmapply’.
  - `fastVersion`: A logic value. If TRUE, the fast approximation is
    used.
  - `corrCut`: A numeric value. The cutoff for non-zero proportions in
    genes used in modelling correlation. The reason is that lowly
    expressed genes are hard to calculate correlation.
  - `BPPARAM`: A MulticoreParam object or NULL. When the parameter
    parallelization = ‘mcmapply’ or ‘pbmcmapply’, this parameter must be
    NULL. When the parameter parallelization = ‘bpmapply’, this
    parameter must be one of the MulticoreParam object offered by the
    package ‘BiocParallel’. The default value is NULL.
  - `approximation`: TBA
  - `usePca`: TBA
  - `nPcs`: TBA

The output of `constructNull()` is the new gene by cell matrix in the
same format as your input.

The following figure briefly describes how ClusterDE generates the
synthetic null data:

![](reference/figures/ClusterDE_supp_null_generation.png)

After obtaining the synthetic null data, use `calcNullPval()` to perform
standard preprocessing and clustering pipeline to get DE p-values
(`nullPvalues`). Finally, we compare the p-values from the null and
p-values from the target data (real data) by `callDE()`. For
illustration, here we use the Uniform random numbers as the p-values.

``` r
set.seed(123)
targetPvalues <- Seurat::FindMarkers(obj, ident.1 = 0, ident.2 = 1)
nullPvalues <- ClusterDE::calcNullPval(nullData)
res <- ClusterDE::callDE(
  targetScores = targetPvalues,
  nullScores = nullPvalues,
  nlogTrans = TRUE,
  FDR = 0.05,
  correct = FALSE
)
```

The parameters of `callDE` are:

  - `targetScores`: A named numeric vector of the DE scores from the
    target data, e.g., the p-values between two clusters from the real
    data.
  - `nullScores`: A named numeric vector of the DE scores from the
    synthetic null data, e.g., the p-values between two clusters from
    the null data.
  - `nlogTrans`: A logical value. If the input scores are p-values, take
    the `-log10` transformation since Clipper require larger scores
    represent more significant DE. Default is TRUE.
  - `FDR`: A numeric value of the target False Discovery Rate (FDR).
    Default is 0.05.
  - `correct`: A logical value. If TRUE, perform the correction to make
    the distribution of contrast scores approximately symmetric. Default
    is FALSE.

The output of `callDE()` is a list of DE genes, same as the output of
`findMarkers()`.

# Tutorials

For all detailed tutorials, please check the
[website](https://songdongyuan1994.github.io/ClusterDE/index.html). The
tutorials will demonstrate the applications of **ClusterDE** in two
cases: a cell line dataset (no cell type exists) and a PBMC dataset.

  - [Perform ClusterDE on a cell line
    dataset](https://songdongyuan1994.github.io/ClusterDE/articles/ClusterDE-cellline.html)
  - [Perform ClusterDE on a PBMC
    dataset](https://songdongyuan1994.github.io/ClusterDE/articles/ClusterDE-PBMC.html)
  - [Perform ClusterDE on a single-domain spatial transcriptomics
    dataset](https://songdongyuan1994.github.io/ClusterDE/articles/ClusterDE-onedomain.html)
  - [Perform ClusterDE on a two-domains spatial transcriptomics
    dataset](https://songdongyuan1994.github.io/ClusterDE/articles/ClusterDE-twodomains.html)

# Contact

Any questions or suggestions on `ClusterDE` are welcomed\! Please report
it on [issues](https://github.com/SONGDONGYUAN1994/ClusterDE/issues), or
contact Dongyuan Song (<dongyuansong@ucla.edu>).

# Related Papers

  - **scDesign3**: [Song, D., Wang, Q., Yan, G. et al. scDesign3
    generates realistic in silico data for multimodal single-cell and
    spatial omics. *Nat Biotechnol*
    (2023).](https://www.nature.com/articles/s41587-023-01772-1)
  - **Clipper**: [Ge, X., Chen, Y.E., Song, D. et al. Clipper:
    p-value-free FDR control on high-throughput data from two
    conditions. *Genome Biology* 22, 288
    (2021).](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-021-02506-9)

# Other methods for double dipping problem

  - **TN test**: [Zhang, J.M., Kamath, G.M., David, N.T. Valid
    post-clustering differential analysis for single-cell rna-seq. *Cell
    Systems*,
    2019](https://www.sciencedirect.com/science/article/pii/S2405471219302698)
  - **count split**: [Neufeld, A., Gao, L.L., Popp, J., Battle, A.,
    Witten, D. Inference after latent variable estimation for
    single-cell RNA sequencing data. *Biostatistics*,
    2022](https://academic.oup.com/biostatistics/advance-article/doi/10.1093/biostatistics/kxac047/6893953?login=true)

# Package index

## All functions

<!-- end list -->

  - `calcNullPval()` : Calculate pval for each gene in synthetic null
    data
  - `callDE()` : Call differentially expressed (DE) genes by Clipper
    algorithm
  - `constructNull()` : Construct the synthetic null data
  - `dimPlot()` : Plot reduced-dimensional embeddings for reference and
    null data
  - `exampleCounts` : A count matrix of 100 genes from the A549 cell
    line from Tian et al., Nature Methods, 2019.
  - `findMarkers()` : Find differential markers using ClusterDE
  - `logcp10k()` : Log-transformed Counts per 10,000 (logCP10K)

# Articles

### All vignettes

  - [Perform ClusterDE on a cell line
    dataset](https://songdongyuan1994.github.io/ClusterDE/articles/ClusterDE-cellline.md):
  - [Perform ClusterDE on a single-domain spatial
    dataset](https://songdongyuan1994.github.io/ClusterDE/articles/ClusterDE-onedomain.md):
  - [Perform ClusterDE on a PBMC
    dataset](https://songdongyuan1994.github.io/ClusterDE/articles/ClusterDE-PBMC.md):
  - [Perform ClusterDE on a two-domain spatial
    dataset](https://songdongyuan1994.github.io/ClusterDE/articles/ClusterDE-twodomains.md):
